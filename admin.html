<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedCalc Admin PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [isAuth, setIsAuth] = useState(false);
            const [activeTab, setActiveTab] = useState('records');
            const [data, setData] = useState([]);
            const [password, setPassword] = useState('');
            const [newDoc, setNewDoc] = useState({ login: '', password: '' });
            const [newPatient, setNewPatient] = useState('');

            useEffect(() => {
                if (isAuth) {
                    loadData(activeTab);
                } else {
                    // Проверка существующей сессии при загрузке
                    fetch('/api/records').then(res => {
                        if (res.ok) {
                            setIsAuth(true);
                            loadData('records');
                        }
                    });
                }
            }, [activeTab, isAuth]);

            const loadData = async (tab) => {
                try {
                    const res = await fetch(`/api/${tab}`);
                    if (res.ok) setData(await res.json());
                    else if (res.status === 401) setIsAuth(false);
                } catch (e) { console.error(e); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (res.ok) setIsAuth(true);
                else alert('Неверный пароль');
            };

            const addDoctor = async () => {
                if(!/^[a-z]\.[a-z]\.[a-z]+$/.test(newDoc.login)) {
                    alert('Логин должен быть i.i.ivanov');
                    return;
                }
                await fetch('/api/doctors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newDoc)
                });
                setNewDoc({ login: '', password: '' });
                loadData('doctors');
            };

            const addPatient = async () => {
                await fetch('/api/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ policy: newPatient })
                });
                setNewPatient('');
                loadData('patients');
            };

            if (!isAuth) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100">
                    <form onSubmit={handleLogin} className="bg-white p-10 rounded-3xl shadow-2xl w-96 border border-slate-200 text-center">
                        <div className="bg-blue-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <i className="fa-solid fa-lock text-white text-3xl"></i>
                        </div>
                        <h1 className="text-2xl font-bold mb-2 text-slate-800">Admin Access</h1>
                        <p className="text-slate-500 mb-8">Введите мастер-пароль</p>
                        <input 
                            type="password" 
                            className="w-full border-2 border-slate-100 p-4 rounded-2xl mb-4 outline-none focus:border-blue-500 transition-all text-center text-xl tracking-widest"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                            autoFocus
                        />
                        <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold text-lg transition-all shadow-lg shadow-blue-100">
                            Войти в панель
                        </button>
                    </form>
                </div>
            );

            return (
                <div className="max-w-6xl mx-auto p-6 md:p-12">
                    <div className="flex justify-between items-center mb-10">
                        <div>
                            <h1 className="text-3xl font-black text-slate-900 tracking-tight italic">
                                MED<span className="text-blue-600 underline">CALC</span>
                            </h1>
                            <p className="text-slate-400 font-bold text-xs uppercase tracking-widest mt-1">Professional Database Management</p>
                        </div>
                        <button 
                            onClick={async () => { await fetch('/api/logout', {method:'POST'}); setIsAuth(false); }} 
                            className="bg-red-50 text-red-500 px-6 py-2 rounded-xl font-bold hover:bg-red-100 transition-all"
                        >
                            Выйти
                        </button>
                    </div>

                    <div className="flex gap-10 mb-10 border-b-2 border-slate-100">
                        <button onClick={() => setActiveTab('records')} className={`pb-4 text-sm font-black uppercase tracking-widest transition-all ${activeTab === 'records' ? 'tab-active' : 'text-slate-300'}`}>
                            Расчеты
                        </button>
                        <button onClick={() => setActiveTab('doctors')} className={`pb-4 text-sm font-black uppercase tracking-widest transition-all ${activeTab === 'doctors' ? 'tab-active' : 'text-slate-300'}`}>
                            Врачи
                        </button>
                        <button onClick={() => setActiveTab('patients')} className={`pb-4 text-sm font-black uppercase tracking-widest transition-all ${activeTab === 'patients' ? 'tab-active' : 'text-slate-300'}`}>
                            Пациенты
                        </button>
                    </div>

                    {activeTab === 'records' && (
                        <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 text-slate-400 font-bold text-[10px] uppercase tracking-widest border-b">
                                    <tr>
                                        <th className="p-6">Дата и время</th>
                                        <th className="p-6">Калькулятор</th>
                                        <th className="p-6">Результат</th>
                                        <th className="p-6">Врач</th>
                                        <th className="p-6">Полис пациента</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-slate-50">
                                    {data.map(r => (
                                        <tr key={r.id} className="hover:bg-blue-50/30 transition-all">
                                            <td className="p-6 text-slate-400 font-medium">
                                                {new Date(r.timestamp).toLocaleString()}
                                            </td>
                                            <td className="p-6 font-black text-slate-800">{r.calcId}</td>
                                            <td className="p-6">
                                                <span className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold text-xs shadow-md shadow-blue-200">
                                                    {r.resultValue}
                                                </span>
                                            </td>
                                            <td className="p-6 font-bold text-blue-600">
                                                <i className="fa-solid fa-user-md mr-2 opacity-50"></i>
                                                {r.doctorLogin || '—'}
                                            </td>
                                            <td className="p-6 font-mono font-bold text-slate-600 tracking-tighter italic">
                                                {r.patientPolicy || '—'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {data.length === 0 && <div className="p-20 text-center font-bold text-slate-300 italic">База пуста</div>}
                        </div>
                    )}

                    {activeTab === 'doctors' && (
                        <div className="grid md:grid-cols-3 gap-10">
                            <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 h-fit">
                                <h3 className="font-black text-slate-800 mb-6 uppercase text-sm tracking-widest">Новый профиль</h3>
                                <input placeholder="i.i.ivanov" className="w-full border-2 border-slate-50 p-3 rounded-xl mb-3 outline-none focus:border-blue-400 text-sm font-bold" value={newDoc.login} onChange={e => setNewDoc({...newDoc, login: e.target.value})} />
                                <input placeholder="Пароль" type="password" className="w-full border-2 border-slate-50 p-3 rounded-xl mb-6 outline-none focus:border-blue-400 text-sm font-bold" value={newDoc.password} onChange={e => setNewDoc({...newDoc, password: e.target.value})} />
                                <button onClick={addDoctor} className="w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:bg-blue-600 transition-all">Создать</button>
                            </div>
                            <div className="md:col-span-2 space-y-3">
                                {data.map(d => (
                                    <div key={d.login} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center group hover:border-blue-200 transition-all">
                                        <span className="font-black text-slate-700 tracking-tight">
                                            <i className="fa-solid fa-circle-user mr-3 text-blue-200 group-hover:text-blue-500 transition-all"></i>
                                            {d.login}
                                        </span>
                                        <button onClick={async () => { if(confirm('Удалить?')) { await fetch(`/api/doctors/${d.login}`, {method:'DELETE'}); loadData('doctors'); } }} className="text-slate-200 hover:text-red-500 transition-all p-2">
                                            <i className="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'patients' && (
                        <div className="grid md:grid-cols-3 gap-10">
                            <div className="bg-white p-8 rounded-3xl shadow-lg border border-slate-100 h-fit">
                                <h3 className="font-black text-slate-800 mb-6 uppercase text-sm tracking-widest">Регистрация полиса</h3>
                                <input placeholder="0000 0000 0000 0000" className="w-full border-2 border-slate-50 p-3 rounded-xl mb-6 outline-none focus:border-blue-400 font-mono font-bold" value={newPatient} onChange={e => setNewPatient(e.target.value)} />
                                <button onClick={addPatient} className="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:bg-slate-900 transition-all">Добавить</button>
                            </div>
                            <div className="md:col-span-2 grid grid-cols-2 gap-4">
                                {data.map(p => (
                                    <div key={p.policy} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm font-mono font-bold text-slate-500 flex items-center">
                                        <div className="w-2 h-2 rounded-full bg-green-400 mr-4"></div>
                                        {p.policy}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>